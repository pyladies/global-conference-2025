---
import Layout from "@layouts/Layout.astro";
import Container from "@components/container.astro";
import Sectionhead from "@components/sectionhead.astro";
import SocialsComponent from "../../components/ui/socials.astro";
import { Icon } from "astro-icon/components";

import { getLangFromUrl, useTranslations } from "../../i18n/utils";
import { getLocaleStaticPaths } from "../../i18n/locales";
import volunteers from "../../data/volunteers.js";

export function getStaticPaths() {
    return getLocaleStaticPaths();
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);


//Function to format volunteer team names
function formatTeamName(str) {
  return str
    .split('_')
    .map(w =>
      w.toLowerCase() === "of"
        ? "of"
        : w.charAt(0).toUpperCase() + w.slice(1)
    )
    .join(' ');
}

//Function to format volunteer team names
function formatTeamName(str) {
  return str
    .split('_')
    .map(w =>
      w.toLowerCase() === "of"
        ? "of"
        : w.charAt(0).toUpperCase() + w.slice(1)
    )
    .join(' ');
}

//Function to eliminate duplicates, but keeping the first occurrence
function dedupeVolunteersByName(volunteersObj: any) {
  const seen = new Set<string>();
  const result: Record<string, any[]> = {};

  for (const [groupName, groupList] of Object.entries(volunteersObj)) {
    const list = groupList as { name: string }[];  // This fixes the 'unknown'

    result[groupName] = list.filter(vol => {
      if (seen.has(vol.name)) {
          return false;
      } else {
          seen.add(vol.name);
          return true;
      }
    });
  }

  return result;
}
function buildVolunteerGroupMap(volunteersObj: any) {
    const map: Record<string, string[]> = {};

    for (const [groupName, groupList] of Object.entries(volunteersObj)) {
        const list = groupList as { name: string }[];

        for (const vol of list) {
            if (!map[vol.name]) {
                map[vol.name] = [];
            }
            map[vol.name].push(groupName);
        }
    }

    return map;
}


const uniqueVolunteers = dedupeVolunteersByName(volunteers);
const flatVolunteers = Object.values(uniqueVolunteers).flat();
const volunteerGroups = buildVolunteerGroupMap(volunteers);
---

<Layout title="Volunteers">
    <Container>
        <Sectionhead>
            <Fragment slot="subtitle"
                >{
                    t("Thanks to all the volunteers for making this possible")
                }</Fragment
            >
            <Fragment slot="title">{t("Our Volunteers")}</Fragment>
            <Fragment slot="description"> </Fragment>
        </Sectionhead>

        <!-- Grouping Switch -->
        <div class="flex justify-center mb-12">
            <div
                class="inline-flex items-center bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 p-2"
            >
                <button
                    id="all-btn"
                    class="timezone-btn px-4 py-2 rounded-md font-semibold transition-all duration-300 bg-gradient-to-r from-purple-600 to-pink-600 text-white"
                >
                    <span class="flex items-center gap-2">
                        <Icon name="bx:bx-world" class="w-5 h-5" />
                        {t("See All")}
                    </span>
                </button>
                <button
                    id="grouped-btn"
                    class="timezone-btn px-4 py-2 rounded-md font-semibold transition-all duration-300 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                >
                    <span class="flex items-center gap-2">
                        <Icon name="bx:bx-current-location" class="w-5 h-5" />
                        <span id="local-tz-name">{t("Group by Team")}</span>
                    </span>
                </button>
            </div>
        </div>

        <!-- Displays all volunteers -->
        <div id="volunteers-all">
            {
                <div class="flex justify-center">
                        <div class="grid grid-flow-rows grid-cols-1 gap-10 mb-10 sm:grid-cols-2 md:grid-cols-3 sm:gap-10 lg:grid-cols-4">
                            {
                            flatVolunteers.map((volunteer) => (
                                <div class="flex justify-start">
                                        <div class="w-28 h-28 rounded-full overflow-hidden">
                                        <img
                                            class="w-full h-full object-cover"
                                            src={volunteer.image}
                                            loading="lazy"
                                        />
                                        </div>
                                        <div class="pl-2">
                                            <p class="text-black dark:text-white text-md font-bold">
                                                {volunteer.name}
                                            </p>
                                            <p class="text-black dark:text-white capitalize text-sm font-light italic truncate max-w-[160px]">
                                                {
                                                    volunteerGroups[volunteer.name]
                                                        .map(g => t(g.replaceAll("_", " ")))
                                                        .join(", ")
                                                }
                                            </p>
                                            <div class="flex pt-2">
                                                   {volunteer.links.mastodon && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .mastodon
                                                           }
                                                           social="mastodon"
                                                       />
                                                   )}
                                                   {volunteer.links.bluesky && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .bluesky
                                                           }
                                                           social="bluesky"
                                                       />
                                                   )}
                                                   {volunteer.links.instagram && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .instagram
                                                           }
                                                           social="instagram"
                                                       />
                                                   )}
                                                   {volunteer.links.linkedin && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .linkedin
                                                           }
                                                           social="linkedin"
                                                       />
                                                   )}
                                                   {volunteer.links.twitter && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .twitter
                                                           }
                                                           social="twitter"
                                                       />
                                                   )}
                                                   {volunteer.links.youtube && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links
                                                                   .youtube
                                                           }
                                                           social="youtube"
                                                       />
                                                   )}
                                                   {volunteer.links.git && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links.git
                                                           }
                                                           social="github"
                                                       />
                                                   )}
                                                   {volunteer.links.website && (
                                                       <SocialsComponent
                                                           speakersSocialUrl={
                                                               volunteer.links.website
                                                           }
                                                           social="website"
                                                       />
                                                   )}
                                            </div>
                                        </div>
                                </div>
                        ))}
                    </div>

                </div>

            }
        </div>

        <!-- Displays volunteers grouped by teams -->
        <div id="volunteers-grouped" class="hidden">
            {
                Object.entries(volunteers).map(
                    ([groupName, groupVolunteers]) => (
                        <>
                        {groupVolunteers.length > 0 && (
                            <h1 class="text-3xl lg:text-4xl text-center font-bold lg:tracking-tight capitalize dark:text-white pb-5">
                                {t(formatTeamName(groupName))}
                            </h1>

                                <div class="flex justify-center">
                                    <div class="grid grid-flow-rows grid-cols-1 gap-10 mb-10 sm:grid-cols-2 md:grid-cols-3 sm:gap-10 lg:grid-cols-4">
                                        {groupVolunteers.map((volunteer) => (
                                            <div class="flex justify-start">
                                                    <div class="w-28 h-28 rounded-full overflow-hidden">
                                                    <img
                                                        class="w-full h-full object-cover"
                                                        src={volunteer.image}
                                                        loading="lazy"
                                                    />
                                                    </div>
                                                    <div class="pl-2">
                                                        <p class="text-black dark:text-white text-md font-bold">
                                                            {volunteer.name}
                                                        </p>
                                                        <div class="flex pt-2">
                                                            {volunteer.links.mastodon && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .mastodon
                                                                    }
                                                                    social="mastodon"
                                                                />
                                                            )}
                                                            {volunteer.links.bluesky && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .bluesky
                                                                    }
                                                                    social="bluesky"
                                                                />
                                                            )}
                                                            {volunteer.links.instagram && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .instagram
                                                                    }
                                                                    social="instagram"
                                                                />
                                                            )}
                                                            {volunteer.links.linkedin && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .linkedin
                                                                    }
                                                                    social="linkedin"
                                                                />
                                                            )}
                                                            {volunteer.links.twitter && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .twitter
                                                                    }
                                                                    social="twitter"
                                                                />
                                                            )}
                                                            {volunteer.links.youtube && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links
                                                                            .youtube
                                                                    }
                                                                    social="youtube"
                                                                />
                                                            )}
                                                            {volunteer.links.git && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links.git
                                                                    }
                                                                    social="github"
                                                                />
                                                            )}
                                                            {volunteer.links.website && (
                                                                <SocialsComponent
                                                                    speakersSocialUrl={
                                                                        volunteer.links.website
                                                                    }
                                                                    social="website"
                                                                />
                                                            )}
                                                        </div>
                                                    </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                        )}

                        </>
                    ),
                )
            }
        </div>


        <script define:vars={{ volunteers }}>
            //Define switch variable
            let groupedSelectedBtn = true;
            //

            //Just updates de switch buttons styles
            function updateSwitchButtons() {
                const allBtn = document.getElementById("all-btn");
                const groupedBtn = document.getElementById("grouped-btn");

                if (allBtn && groupedBtn) {
                    if (groupedSelectedBtn) {
                        allBtn.classList.remove(
                            "bg-gradient-to-r",
                            "from-purple-600",
                            "to-pink-600",
                            "text-white",
                        );
                        allBtn.classList.add(
                            "text-gray-700",
                            "dark:text-gray-300",
                            "hover:bg-gray-100",
                            "dark:hover:bg-gray-700",
                        );

                        groupedBtn.classList.remove(
                            "text-gray-700",
                            "dark:text-gray-300",
                            "hover:bg-gray-100",
                            "dark:hover:bg-gray-700",
                        );
                        groupedBtn.classList.add(
                            "bg-gradient-to-r",
                            "from-purple-600",
                            "to-pink-600",
                            "text-white",
                        );
                    } else {
                        groupedBtn.classList.remove(
                            "bg-gradient-to-r",
                            "from-purple-600",
                            "to-pink-600",
                            "text-white",
                        );
                        groupedBtn.classList.add(
                            "text-gray-700",
                            "dark:text-gray-300",
                            "hover:bg-gray-100",
                            "dark:hover:bg-gray-700",
                        );

                        allBtn.classList.remove(
                            "text-gray-700",
                            "dark:text-gray-300",
                            "hover:bg-gray-100",
                            "dark:hover:bg-gray-700",
                        );
                        allBtn.classList.add(
                            "bg-gradient-to-r",
                            "from-purple-600",
                            "to-pink-600",
                            "text-white",
                        );
                    }
                }
            }

            //Displays volunteers based on the selected switch
            function updateVolunteersDisplay() {
                document.getElementById("volunteers-all").classList.toggle("hidden", groupedSelectedBtn);
                document.getElementById("volunteers-grouped").classList.toggle("hidden", !groupedSelectedBtn);
            }

            function initializeVolunteersPage() {

                const allBtn = document.getElementById("all-btn");
                const groupedBtn = document.getElementById("grouped-btn");

                //Adding event listeners to the switch buttons
                if (allBtn) {
                    allBtn.addEventListener("click", () => {
                        groupedSelectedBtn = false;
                        updateSwitchButtons();
                        updateVolunteersDisplay();
                    });
                }

                if (groupedBtn) {
                    groupedBtn.addEventListener("click", () => {
                        groupedSelectedBtn = true;
                        updateSwitchButtons();
                        updateVolunteersDisplay();
                    });
                }
            }

            //Call initialization onboth DOMContentLoaded and Astro page load
            document.addEventListener(
                "DOMContentLoaded",
                initializeVolunteersPage,
            );
            document.addEventListener(
                "astro:page-load",
                initializeVolunteersPage,
            );
        </script>
    </Container>
</Layout>
